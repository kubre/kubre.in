---
import Layout from "../../layouts/Layout.astro";
import TravelCard from "../../components/TravelCard.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { toSentenceCase } from "../../utils/text";
import { DATE_FORMATTERS } from "../../utils/date";

const entries = await getCollection("travel").then((entries) => {
    return entries.sort((a, b) => {
        return (
            new Date(b.data.visitedAt).valueOf() -
            new Date(a.data.visitedAt).valueOf()
        );
    });
});

// Load all images from all travel folders
const allTravelImages = import.meta.glob<{ default: ImageMetadata }>(
    "/src/assets/travel/**/*.{jpg,jpeg,png,gif,JPG,JPEG,PNG,webp}",
);

// Map images to their parent trip for date association
const photos = await Promise.all(
    Object.entries(allTravelImages).map(async ([path, importFn]) => {
        const img = await importFn();
        const pathParts = path.split("/");
        const slug = pathParts[4]; // Extract slug from path: /src/assets/travel/{slug}/...
        const trip = entries.find((e) => e.slug === slug);
        const filename = pathParts.pop()!;
        return {
            src: img.default,
            caption: toSentenceCase(filename),
            tripSlug: slug,
            tripTitle: trip?.data.title || slug,
            visitedAt: trip?.data.visitedAt || new Date(),
        };
    }),
);

// Sort by trip date (newest first)
photos.sort(
    (a, b) => new Date(b.visitedAt).valueOf() - new Date(a.visitedAt).valueOf(),
);

// Group images by trip for Google Photos-style display
type Photo = (typeof photos)[number];
const imagesByTrip = photos.reduce(
    (acc, img) => {
        if (!acc[img.tripSlug]) {
            acc[img.tripSlug] = {
                tripTitle: img.tripTitle,
                tripSlug: img.tripSlug,
                visitedAt: img.visitedAt,
                images: [],
            };
        }
        acc[img.tripSlug].images.push(img);
        return acc;
    },
    {} as Record<
        string,
        {
            tripTitle: string;
            tripSlug: string;
            visitedAt: Date;
            images: Photo[];
        }
    >,
);

// Convert to array and sort by date (newest first)
const groupedTrips = Object.values(imagesByTrip).sort(
    (a, b) => new Date(b.visitedAt).valueOf() - new Date(a.visitedAt).valueOf(),
);
---

<Layout
    title="Travel"
    description="Vaibhav's travel journal - places visited with photos and notes"
>
    <link
        slot="head"
        rel="alternate"
        type="application/rss+xml"
        title="Vaibhav Kubre's Travel"
        href="/travel/rss.xml"
    />
    <main class="py-12 grid">
        <!-- View Toggle -->
        <div class="flex gap-2 mb-8 font-mono text-sm">
            <button
                id="view-timeline"
                class="px-3 py-1 bg-carbon text-enamel transition-colors"
            >
                Timeline
            </button>
            <button
                id="view-photos"
                class="px-3 py-1 text-carbon-lighter hover:bg-carbon hover:text-enamel transition-colors"
            >
                Photos
            </button>
        </div>

        <!-- Timeline View -->
        <div id="timeline-view" class="relative mt-12 ml-0 lg:ml-[200px]">
            <div
                class="hidden absolute top-3 bottom-0 right-full mr-7 md:mr-[3.25rem] w-px bg-carbon-lighter sm:block"
            >
            </div>
            <div class="space-y-16">
                {entries.map((entry) => <TravelCard entry={entry} />)}
            </div>
        </div>

        <!-- Photos View -->
        <div id="photos-view" class="hidden space-y-8">
            {
                groupedTrips.map(
                    ({ tripTitle, tripSlug, visitedAt, images }) => (
                        <section>
                            <header class="mb-3 flex items-baseline gap-3">
                                <a
                                    href={`/travel/${tripSlug}`}
                                    class="font-mono text-lg text-carbon hover:text-yellow-600 transition-colors"
                                >
                                    {tripTitle}
                                </a>
                                <time
                                    datetime={visitedAt.toISOString()}
                                    class="font-mono text-sm text-carbon-lighter"
                                >
                                    {DATE_FORMATTERS.full.format(visitedAt)}
                                </time>
                            </header>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                                {images.map(({ src, caption }) => (
                                    <figure class="relative group overflow-hidden">
                                        <Image
                                            src={src}
                                            width={300}
                                            format="webp"
                                            quality={75}
                                            alt={caption}
                                            loading="lazy"
                                            data-lightbox
                                            data-full={src.src}
                                            data-trip-slug={tripSlug}
                                            data-trip-title={tripTitle}
                                            data-image-id={`${tripSlug}-${caption.toLowerCase().replace(/\s+/g, "-")}`}
                                            class="w-full h-auto cursor-pointer hover:opacity-80 transition-opacity"
                                        />
                                    </figure>
                                ))}
                            </div>
                        </section>
                    ),
                )
            }
        </div>
        <div class="pt-16 text-gray-700 text-center">
            I will soon add more awesome trips from the past :D
        </div>
    </main>

    <!-- Lightbox -->
    <div
        id="lightbox"
        class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-4"
    >
        <button
            id="lb-close"
            class="absolute top-4 right-4 text-white text-3xl cursor-pointer hover:text-yellow-400 transition-colors"
            >&times;</button
        >
        <button
            id="lb-prev"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-3xl cursor-pointer hover:text-yellow-400 transition-colors"
            >&larr;</button
        >
        <button
            id="lb-next"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-3xl cursor-pointer hover:text-yellow-400 transition-colors"
            >&rarr;</button
        >
        <!-- Blurred placeholder (shows thumbnail) -->
        <img id="lb-placeholder" class="absolute max-h-[80vh] max-w-[90vw] object-contain blur-lg scale-105 opacity-50 hidden" alt="" />
        <!-- Full resolution image -->
        <img id="lb-img" class="max-h-[80vh] max-w-[90vw] object-contain transition-opacity duration-300" alt="" />
        <!-- Loading indicator -->
        <div id="lb-loader" class="absolute bottom-20 left-1/2 -translate-x-1/2 text-white/70 font-mono text-sm hidden">
            Loading...
        </div>
        <div class="mt-4 text-white text-center font-mono">
            <p id="lb-caption"></p>
            <a
                id="lb-trip-link"
                href="#"
                class="inline-block mt-2 text-sm text-yellow-400 hover:underline"
                >View trip &rarr;</a
            >
        </div>
    </div>
</Layout>

<script>
    // View toggle
    const timelineBtn = document.getElementById("view-timeline");
    const photosBtn = document.getElementById("view-photos");
    const timelineView = document.getElementById("timeline-view");
    const photosView = document.getElementById("photos-view");

    function setView(view: "timeline" | "photos", updateUrl = true) {
        if (view === "timeline") {
            timelineView?.classList.remove("hidden");
            photosView?.classList.add("hidden");
            timelineBtn?.classList.add("bg-carbon", "text-enamel");
            timelineBtn?.classList.remove("text-carbon-lighter");
            photosBtn?.classList.remove("bg-carbon", "text-enamel");
            photosBtn?.classList.add("text-carbon-lighter");
        } else {
            timelineView?.classList.add("hidden");
            photosView?.classList.remove("hidden");
            photosBtn?.classList.add("bg-carbon", "text-enamel");
            photosBtn?.classList.remove("text-carbon-lighter");
            timelineBtn?.classList.remove("bg-carbon", "text-enamel");
            timelineBtn?.classList.add("text-carbon-lighter");
        }

        if (updateUrl) {
            const url = new URL(window.location.href);
            if (view === "photos") {
                url.searchParams.set("view", "photos");
            } else {
                url.searchParams.delete("view");
            }
            url.searchParams.delete("photo"); // close lightbox when switching views
            history.pushState({}, "", url);
        }
    }

    timelineBtn?.addEventListener("click", () => setView("timeline"));
    photosBtn?.addEventListener("click", () => setView("photos"));

    // Lightbox
    const lightbox = document.getElementById("lightbox");
    const lbImg = document.getElementById("lb-img") as HTMLImageElement;
    const lbPlaceholder = document.getElementById("lb-placeholder") as HTMLImageElement;
    const lbLoader = document.getElementById("lb-loader");
    const lbCaption = document.getElementById("lb-caption");
    const lbTripLink = document.getElementById(
        "lb-trip-link",
    ) as HTMLAnchorElement;
    let images: HTMLImageElement[] = [];
    let currentIndex = 0;

    function updateLightboxImages() {
        // Only include visible images (from the active view)
        const photosVisible = !photosView?.classList.contains("hidden");
        if (photosVisible) {
            images = Array.from(
                photosView?.querySelectorAll("[data-lightbox]") || [],
            ) as HTMLImageElement[];
        } else {
            images = [];
        }
    }

    function preloadAdjacentImages() {
        if (images.length === 0) return;
        const prevIndex = (currentIndex - 1 + images.length) % images.length;
        const nextIndex = (currentIndex + 1) % images.length;
        [prevIndex, nextIndex].forEach(idx => {
            const img = images[idx];
            if (img?.dataset.full) {
                const preload = new Image();
                preload.src = img.dataset.full;
            }
        });
    }

    function openLightbox(index: number, updateUrl = true) {
        updateLightboxImages();
        currentIndex = index;
        const img = images[index];
        if (!img) return;

        const fullSrc = img.dataset.full || "";
        const thumbSrc = img.src;

        // Show placeholder immediately (already loaded thumbnail, blurred)
        lbPlaceholder.src = thumbSrc;
        lbPlaceholder.classList.remove("hidden");

        // Hide main image and show loader
        lbImg.classList.add("opacity-0");
        lbLoader?.classList.remove("hidden");

        // Update caption
        if (lbCaption) lbCaption.textContent = img.alt;
        if (lbTripLink) {
            const slug = img.dataset.tripSlug || "";
            const title = img.dataset.tripTitle || "View trip";
            lbTripLink.href = `/travel/${slug}`;
            lbTripLink.textContent = `${title} â†’`;
        }

        // Show lightbox
        lightbox?.classList.remove("hidden");
        lightbox?.classList.add("flex");

        // Load full image
        const fullImage = new Image();
        fullImage.onload = () => {
            lbImg.src = fullSrc;
            lbImg.classList.remove("opacity-0");
            lbPlaceholder.classList.add("hidden");
            lbLoader?.classList.add("hidden");
            preloadAdjacentImages();
        };
        fullImage.src = fullSrc;

        if (updateUrl) {
            const imageId = img.dataset.imageId;
            if (imageId) {
                const url = new URL(window.location.href);
                url.searchParams.set("photo", imageId);
                history.pushState({}, "", url);
            }
        }
    }

    function closeLightbox(updateUrl = true) {
        lightbox?.classList.add("hidden");
        lightbox?.classList.remove("flex");

        if (updateUrl) {
            const url = new URL(window.location.href);
            url.searchParams.delete("photo");
            history.pushState({}, "", url);
        }
    }

    function navigate(delta: number) {
        if (images.length === 0) return;
        currentIndex = (currentIndex + delta + images.length) % images.length;
        openLightbox(currentIndex); // already updates URL
    }

    // Attach click handlers to photos
    photosView?.querySelectorAll("[data-lightbox]").forEach((img, i) => {
        img.addEventListener("click", () => openLightbox(i));
    });

    document
        .getElementById("lb-close")
        ?.addEventListener("click", () => closeLightbox());
    document
        .getElementById("lb-prev")
        ?.addEventListener("click", () => navigate(-1));
    document
        .getElementById("lb-next")
        ?.addEventListener("click", () => navigate(1));
    lightbox?.addEventListener(
        "click",
        (e) => e.target === lightbox && closeLightbox(),
    );
    document.addEventListener("keydown", (e) => {
        if (lightbox?.classList.contains("hidden")) return;
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") navigate(-1);
        if (e.key === "ArrowRight") navigate(1);
    });

    // Initialize state from URL
    function initFromUrl() {
        const url = new URL(window.location.href);
        const view = url.searchParams.get("view");
        const photoId = url.searchParams.get("photo");

        // Set view without updating URL
        if (view === "photos") {
            setView("photos", false);
        } else {
            setView("timeline", false);
        }

        // Close lightbox first (in case we're navigating back)
        closeLightbox(false);

        // Open lightbox if photo specified and in photos view
        if (photoId && view === "photos") {
            const img = photosView?.querySelector(
                `[data-image-id="${photoId}"]`,
            ) as HTMLImageElement | null;
            if (img) {
                const allImages = Array.from(
                    photosView?.querySelectorAll("[data-lightbox]") || [],
                );
                const index = allImages.indexOf(img);
                if (index >= 0) {
                    openLightbox(index, false);
                }
            }
        }
    }

    // Initialize on page load
    initFromUrl();

    // Handle browser back/forward
    window.addEventListener("popstate", () => {
        initFromUrl();
    });
</script>
